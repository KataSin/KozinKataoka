#include "GamePlay.h"
#include "../AllInclude.h"
#include "../Def.h"
#include "../game/WorkFolder.h"
#include "../graphic/Model.h"
#include "../graphic/Sprite.h"
#include "../input/GamePad.h"
#include "../input/Keyboard.h"
#include "../sound/Sound.h"

#include "../math/Math.h"
#include "../time/Time.h"

#include "../actor/CameraActor.h"
#include "../UIactor/fadePanel/FadePanel.h"
#include "../game/Random.h"

#include "../actor/Player.h"
#include "../actor/Stage.h"
#include "../actor/StagePlate/DefaultPlate.h"
#include "../actor/ParticleManager/ParticleManager.h"
#include "../actor/ID.h"
#include "../actor/StageLineManager/StageLine/StageLine.h"
#include "../actor/Pool/Pool.h"
#include "../UIactor/GameTimer/GameTimerUI.h"
#include "../UIactor/GameFrameUI/GameFrameUI.h"
#include "../UIactor/ResultUI/ResultUI.h"
#include "../UIactor/GamePlayFontUI/GamePlayFontUI.h"
//コンストラクタ
GamePlay::GamePlay(GameManager& gameManager) :
	mGameManager(&gameManager),
	mRandCount(0)
{
	mGamePlayManager = std::make_shared<GamePlayManager>(wo);
}

//デストラクタ
GamePlay::~GamePlay()
{

}

//開始
void GamePlay::Initialize()
{
	mIsEnd = false;
	mIsEndRanund = false;
	mStartFontFlag = true;
	mNextScene = Scene::GamePlay;
	//ラウンドを設定
	mEndRaundCount = 3;
	wo.Add(ACTOR_ID::STAGE_ACTOR, std::make_shared<Stage>(wo));
	//タイマー設定
	auto gameTimer = std::make_shared<GameTimerUI>(wo, Vector2(WINDOW_WIDTH / 2, WINDOW_HEIGHT / 2), 180.0f);
	wo.UIAdd(UI_ID::GAMETIMER_UI, gameTimer);
	mGameTimer = gameTimer.get();

	wo.UIAdd(UI_ID::GAMEFRAME_UI, std::make_shared<GameFrameUI>(wo, Vector2::Zero));
	auto font = std::make_shared<GamePlayFontUI>(wo);
	wo.UIAdd(UI_ID::FONT_UI, font);
	fontUi = static_cast<GamePlayFontUI*>(font.get());

	fontUi->StartFont(SPRITE_ID::YO_I_FONT_SPRITE);

	SetLightEnable(true);
	SetLightDirection(Vector3::ToVECTOR(Vector3(-1, -1, -1)));

	//勝ったプレイヤー初期化
	mWinPlayer = PLAYER_NUMBER::PLAYER_NULL;

	mFontFlag = true;
	//プレイヤー操作不能
	wo.SetInputPlayer(false);

	gameTimer->StopTimer(true);
	//ライトの設定(不具合あり)
	//light.SetDirectionalLight("GamePlayLight", Vector3(-1, -1, -1));
}

void GamePlay::Update()
{
	//よーいフォントが終わったらプレイヤーの操作開始
	if (fontUi->GetEndFont(SPRITE_ID::YO_I_FONT_SPRITE)&&mStartFontFlag) {
		fontUi->StartFont(SPRITE_ID::DON_SPRITE,8.0f);
		wo.SetInputPlayer(true);
		mGameTimer->StopTimer(false);
		mStartFontFlag = false;
	}
	if (mIsEndRanund) {
		if (GamePad::GetInstance().ButtonTriggerDown(PADBUTTON::NUM1)||
			Keyboard::GetInstance().KeyTriggerDown(KEYCODE::SPACE)) {
			mIsEnd = true;
			mRandCount++;
			//全ラウンド終わってたらリザルトへ
			if (mRandCount > mEndRaundCount) {
				mNextScene = Scene::Result;
				//勝った人たちをセット
				mGameManager->SetPlayerRank(mGamePlayManager->IsFinalWinPlayer());
			}
		}
	}
	else
	{
		if (mGamePlayManager->EndRaund()) {
			if (mFontFlag) {
				mGameTimer->StopTimer(true);
				//勝ったプレイヤーを入れる
				mWinPlayer = mGamePlayManager->IsWinPlayer();
				//そこまで表示
				fontUi->StartFont(SPRITE_ID::SOKOMADE_FONT_SPRITE);
				mFontFlag = false;
			}
			else if (fontUi->GetEndFont(SPRITE_ID::SOKOMADE_FONT_SPRITE)) {
				//そこまで表示終わったらリザルト画像を表示
				wo.UIAdd(UI_ID::RESULT_UI, std::make_shared<ResultUI>(wo, *mGamePlayManager.get(), mWinPlayer));
				mIsEndRanund = true;
				mFontFlag = true;
			}
		}
		else if (mGamePlayManager->TimeUp()) {
			if (mFontFlag) {
				mGameTimer->StopTimer(true);
				//そこまで表示
				fontUi->StartFont(SPRITE_ID::SOKOMADE_FONT_SPRITE);
				mFontFlag = false;
			}
			else if (fontUi->GetEndFont(SPRITE_ID::SOKOMADE_FONT_SPRITE)) {
				//引き分け表示(ずっと)
				fontUi->StartFont(SPRITE_ID::HIKIWAKE_FONT_SPRITE, true);
				mFontFlag = true;
				mIsEndRanund = true;
			}
		}
	}
	wo.Update();
}

//描画
void GamePlay::Draw()
{
	//カメラの描写の位置を設定
	dynamic_cast<CameraActor*>(wo.GetCamera(PLAYER_NUMBER::PLAYER_1).get())->SetCamera();
	//カメラの描写位置を設定し終わった後にプレイヤーごとのUIをUpdateしてDrawをしなくてはいけない
	wo.UpdateUI(PLAYER_NUMBER::PLAYER_1);
	wo.Draw();
	dynamic_cast<CameraActor*>(wo.GetCamera(PLAYER_NUMBER::PLAYER_2).get())->SetCamera();
	wo.UpdateUI(PLAYER_NUMBER::PLAYER_2);
	wo.Draw();
	dynamic_cast<CameraActor*>(wo.GetCamera(PLAYER_NUMBER::PLAYER_3).get())->SetCamera();
	wo.UpdateUI(PLAYER_NUMBER::PLAYER_3);
	wo.Draw();
	dynamic_cast<CameraActor*>(wo.GetCamera(PLAYER_NUMBER::PLAYER_4).get())->SetCamera();
	wo.UpdateUI(PLAYER_NUMBER::PLAYER_4);
	wo.Draw();
	//UI表示のため設定を初期化
	SetCameraScreenCenter(WINDOW_WIDTH / 2, WINDOW_HEIGHT / 2);
	SetDrawArea(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);
	//UIは一回だけdrawでOK
	wo.UIDraw();
	DrawFormatString(0, 368, GetColor(255, 255, 255), "ゲームプレイシーン");
	//DrawSphere3D(Vector3::ToVECTOR(Vector3(0,0,0)), 1.0f, 20, GetColor(255, 255, 255), GetColor(255, 255, 255), FALSE);
}

//終了しているか？
bool GamePlay::IsEnd() const
{
	return mIsEnd;
}

//次のシーンを返す
Scene GamePlay::Next() const
{
	return mNextScene;
}

void GamePlay::End()
{
	mRandCount++;
	//リザルトだったら0にする＆勝ち数リセット
	if (mNextScene == Scene::Result) {
		mRandCount = 0;
		mGamePlayManager->ResetWin();
	}
	wo.Clear();
}